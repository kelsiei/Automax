@model IEnumerable<CarCareTracker.Models.Reminder.ReminderEmailDigest>

@{
    ViewData["Title"] = "Reminder Email Digests";
    var enabled = ViewBag.EnableReminderEmails as bool? ?? false;
    var daysAhead = ViewBag.ReminderEmailDaysAhead as int?;
}

<h1>Reminder Email Digests</h1>

@if (TempData["StatusMessage"] is string status && !string.IsNullOrWhiteSpace(status))
{
    <div class="alert alert-info" role="alert">
        @status
    </div>
}

<div class="mb-3">
    <p class="text-muted">
        Reminder email digests are
        <strong>@(enabled ? "enabled" : "disabled")</strong>.
        @if (enabled)
        {
            <span>
                The current window is <strong>@(daysAhead ?? 7)</strong> day(s) ahead.
            </span>
        }
    </p>
</div>

<form asp-action="Send" method="post" class="mb-3">
    @Html.AntiForgeryToken()
    <button type="submit" class="btn btn-primary" @(enabled ? "" : "disabled")>
        Send digests now
    </button>
    @if (!enabled)
    {
        <span class="text-muted ms-2">
            (Enable reminder email digests in Settings to send emails.)
        </span>
    }
    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary ms-2">Back to Dashboard</a>
</form>

@if (Model == null || !Model.Any())
{
    <p class="text-muted">
        No reminder email digests would be sent at this time.
    </p>
}
else
{
    <p class="text-muted">
        Preview of reminder email digests that would be sent:
    </p>

    @foreach (var digest in Model)
    {
        <div class="card mb-3">
            <div class="card-header">
                <strong>@digest.UserName</strong>
                <span class="text-muted">&lt;@digest.EmailAddress&gt;</span>
            </div>
            <div class="card-body">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Due Date</th>
                            <th>Vehicle</th>
                            <th>Description</th>
                            <th>Urgency</th>
                            <th>Target Odometer</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var r in digest.Reminders)
                    {
                        <tr>
                            <td>@(r.DueDate?.ToShortDateString() ?? "")</td>
                            <td>@r.Year @r.Make @r.Model (@r.LicensePlate)</td>
                            <td>@r.Description</td>
                            <td>@r.Urgency</td>
                            <td>
                                @if (r.TargetOdometer.HasValue)
                                {
                                    @r.TargetOdometer.Value
                                }
                            </td>
                            <td>@r.Tags</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }
}
