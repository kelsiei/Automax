@model CarCareTracker.Models.Vehicle.VehicleIndexViewModel

@{
    ViewData["Title"] = "Garage";
}

<h1>Garage</h1>

<p>
    <a asp-action="Create" class="btn btn-primary">Add Vehicle</a>
</p>

<form method="get" class="row g-2 mb-3">
    <div class="col-md-6">
        <input type="text"
               name="searchTerm"
               value="@(Model.SearchTerm)"
               class="form-control"
               placeholder="Search by year, make, model, or plate..." />
    </div>
    <div class="col-md-3 d-flex align-items-center">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="showOnlyUrgent" value="true" @(Model.ShowOnlyUrgent ? "checked" : "") />
            <input type="hidden" name="showOnlyUrgent" value="false" />
            <label class="form-check-label">Urgent only</label>
        </div>
    </div>
    <div class="col-md-3 d-flex align-items-center">
        <button type="submit" class="btn btn-outline-primary me-2">Apply</button>
        @if (!string.IsNullOrWhiteSpace(Model.SearchTerm) || Model.ShowOnlyUrgent)
        {
            <span class="text-muted small">Showing filtered results</span>
        }
    </div>
</form>

@if (Model == null || !Model.Vehicles.Any())
{
    <p class="text-muted">
        No vehicles have been added yet. Use the <strong>Add Vehicle</strong> button above to create your first vehicle.
    </p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Make</th>
                    <th>Model</th>
                    <th>License Plate</th>
                    <th>Odometer</th>
                    <th>Gas</th>
                    <th>Service</th>
                    <th>Reminders</th>
                    <th>Notes</th>
                    <th>Plans</th>
                    <th>Documents</th>
                    <th class="text-end">Last Mileage</th>
                    <th class="text-end">Last Service</th>
                    <th class="text-end">Last Fill-Up</th>
                    <th class="text-end">Active Plans</th>
                    <th class="text-end">Notes Count</th>
                    <th class="text-end">Documents Count</th>
                    <th class="text-end">Total Cost</th>
                    <th class="text-end">Cost / Mile</th>
                    <th class="text-center">Urgent Reminders</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            @foreach (var vm in Model.Vehicles)
            {
                <tr>
                    <td>@vm.Vehicle.Year</td>
                    <td>@vm.Vehicle.Make</td>
                    <td>@vm.Vehicle.Model</td>
                    <td>@vm.Vehicle.LicensePlate</td>
                    <td>
                        <a asp-controller="Odometer"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td>
                        <a asp-controller="Gas"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td>
                        <a asp-controller="Service"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td>
                        <a asp-controller="Reminder"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td>
                        <a asp-controller="Note"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td>
                        <a asp-controller="Plan"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td>
                        <a asp-controller="Document"
                           asp-action="Index"
                           asp-route-vehicleId="@vm.Vehicle.Id"
                           class="btn btn-sm btn-outline-primary">
                            View
                        </a>
                    </td>
                    <td class="text-end">@vm.LastReportedMileage</td>
                    <td class="text-end">
                        @(vm.LastServiceDate.HasValue ? vm.LastServiceDate.Value.ToShortDateString() : "")
                    </td>
                    <td class="text-end">
                        @(vm.LastGasDate.HasValue ? vm.LastGasDate.Value.ToShortDateString() : "")
                    </td>
                    <td class="text-end">@vm.ActivePlanCount</td>
                    <td class="text-end">@vm.NoteCount</td>
                    <td class="text-end">@vm.DocumentCount</td>
                    <td class="text-end">@vm.TotalCost</td>
                    <td class="text-end">@vm.CostPerMile</td>
                    <td class="text-center">
                        @if (vm.HasUrgentReminders)
                        {
                            <span class="badge bg-danger">Urgent</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">None</span>
                        }
                    </td>
                    <td class="text-end">
                        <a asp-action="Edit" asp-route-id="@vm.Vehicle.Id" class="btn btn-sm btn-outline-secondary">Edit</a>
                        <form asp-action="Delete" asp-route-id="@vm.Vehicle.Id" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Are you sure you want to delete this vehicle?');">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <nav aria-label="Garage pagination">
        <ul class="pagination">
            <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@(Model.CurrentPage - 1)"
                   asp-route-searchTerm="@Model.SearchTerm"
                   asp-route-showOnlyUrgent="@Model.ShowOnlyUrgent">Previous</a>
            </li>
            <li class="page-item disabled">
                <span class="page-link">
                    Page @Model.CurrentPage of @Model.TotalPages
                </span>
            </li>
            <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@(Model.CurrentPage + 1)"
                   asp-route-searchTerm="@Model.SearchTerm"
                   asp-route-showOnlyUrgent="@Model.ShowOnlyUrgent">Next</a>
            </li>
        </ul>
    </nav>
}
